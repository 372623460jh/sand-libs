"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = img;

function _react() {
  const data = _interopRequireDefault(require("react"));

  _react = function _react() {
    return data;
  };

  return data;
}

function _path() {
  const data = _interopRequireDefault(require("path"));

  _path = function _path() {
    return data;
  };

  return data;
}

function _unistUtilVisit() {
  const data = _interopRequireDefault(require("unist-util-visit"));

  _unistUtilVisit = function _unistUtilVisit() {
    return data;
  };

  return data;
}

function _hastUtilHasProperty() {
  const data = _interopRequireDefault(require("hast-util-has-property"));

  _hastUtilHasProperty = function _hastUtilHasProperty() {
    return data;
  };

  return data;
}

function _hastUtilIsElement() {
  const data = _interopRequireDefault(require("hast-util-is-element"));

  _hastUtilIsElement = function _hastUtilIsElement() {
    return data;
  };

  return data;
}

var _externalDemo = require("./externalDemo");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function isRelativeUrl(url) {
  return typeof url === 'string' && !/^(?:https?:)?\/\//.test(url) && !_path().default.isAbsolute(url);
}

function img() {
  return ast => {
    (0, _unistUtilVisit().default)(ast, 'element', (node, i, parent) => {
      if ((0, _hastUtilIsElement().default)(node, 'img') && (0, _hastUtilHasProperty().default)(node, 'src') && isRelativeUrl(node.properties.src)) {
        parent.children[i] = {
          type: 'raw',
          value: `<img src={require('${node.properties.src}')}>`
        };
      }
    });
    (0, _unistUtilVisit().default)(ast, 'raw', node => {
      if (typeof node.value === 'string') {
        node.value = node.value.replace(/<img.*?\/?>/g, tag => {
          // FIX ME: raw visitor will execute repeat after element visit on Windows OS, temporary way to solve it
          if (!tag.includes('src={require')) {
            const matches = tag.match(/<img ([^>]+?)\/?>/) || [];

            const _HTMLAttrParser = (0, _externalDemo.HTMLAttrParser)(matches[1]),
                  src = _HTMLAttrParser.src,
                  inheritAttrs = _objectWithoutProperties(_HTMLAttrParser, ["src"]);

            if (isRelativeUrl(src)) {
              return `<img src={require('${src}')} {...${JSON.stringify(inheritAttrs)}}>`;
            }
          }

          return tag;
        });
      }
    });
  };
}